<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tetris with Leaderboard</title>
<style>
  body { margin:0; display:flex; flex-direction:column; align-items:center; background:#111; color:white; font-family:Arial,sans-serif;}
  h1 { margin:10px;}
  #game-container { display:flex; flex-direction:column; align-items:center;}
  canvas { background:#000; border:3px solid #fff; width:90vw; max-width:400px; height:auto;}
  #controls { margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;}
  button { padding:10px 20px; font-size:16px; border:none; border-radius:5px; background:#28a; color:white; cursor:pointer;}
  button:active { background:#1c6;}
  #leaderboard { margin-top:20px; background:#222; padding:10px; border-radius:10px; width:90vw; max-width:400px;}
  #leaderboard h2 { margin-top:0; font-size:18px; text-align:center;}
  #leaderboard ol { padding-left:20px;}
</style>
</head>
<body>
<h1>üéÆ Tetris</h1>
<div id="game-container">
  <canvas id="tetris" width="240" height="400"></canvas>
  <div id="controls">
    <button onclick="playerMove(-1)">‚óÄÔ∏è Left</button>
    <button onclick="playerRotate()">üîÑ Rotate</button>
    <button onclick="playerMove(1)">‚ñ∂Ô∏è Right</button>
    <button onclick="playerDrop()">‚¨áÔ∏è Drop</button>
  </div>
</div>

<div id="leaderboard">
  <h2>üèÜ Leaderboard</h2>
  <ol id="leaderboard-list"></ol>
</div>

<script type="module">
// ----- Firebase Setup -----
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAHHeVXDJCI4P629__91RgRktJCQqywNDQ",
  authDomain: "tetrisgame-b0340.firebaseapp.com",
  projectId: "tetrisgame-b0340",
  storageBucket: "tetrisgame-b0340.appspot.com",
  messagingSenderId: "798398025637",
  appId: "1:798398025637:web:2a8957a305cf52a15ea24c",
  measurementId: "G-M4LECY3M0Q"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ----- Canvas & Game Setup -----
const canvas = document.getElementById("tetris");
const context = canvas.getContext("2d");
context.scale(20,20);

const pieces = "TJLOSZI";
function createPiece(type) {
  if(type==="T") return [[0,0,0],[1,1,1],[0,1,0]];
  if(type==="O") return [[2,2],[2,2]];
  if(type==="L") return [[0,3,0],[0,3,0],[0,3,3]];
  if(type==="J") return [[0,4,0],[0,4,0],[4,4,0]];
  if(type==="I") return [[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]];
  if(type==="S") return [[0,6,6],[6,6,0],[0,0,0]];
  if(type==="Z") return [[7,7,0],[0,7,7],[0,0,0]];
}

function createMatrix(w,h){ const matrix=[]; while(h--) matrix.push(new Array(w).fill(0)); return matrix;}

let arena = createMatrix(12,20);
let player = {pos:{x:0,y:0}, matrix:null, score:0};
let dropCounter=0, dropInterval=700, lastTime=0;

// ----- Game Functions -----
function collide(arena,player){
  const m=player.matrix, o=player.pos;
  for(let y=0;y<m.length;y++){
    for(let x=0;x<m[y].length;x++){
      if(m[y][x]!==0 && (arena[y+o.y] && arena[y+o.y][x+o.x])!==0) return true;
    }
  }
  return false;
}

function merge(arena,player){
  player.matrix.forEach((row,y)=>{ row.forEach((value,x)=>{ if(value!==0) arena[y+player.pos.y][x+player.pos.x]=value;});});
}

function arenaSweep(){
  outer: for(let y=arena.length-1;y>=0;y--){
    for(let x=0;x<arena[y].length;x++){
      if(arena[y][x]===0) continue outer;
    }
    const row = arena.splice(y,1)[0].fill(0);
    arena.unshift(row);
    y++;
    player.score+=10;
  }
  updateScore();
}

function playerDrop(){
  player.pos.y++;
  if(collide(arena,player)){
    player.pos.y--;
    merge(arena,player);
    playerReset();
    arenaSweep();
  }
  dropCounter=0;
}

function playerMove(dir){
  player.pos.x += dir;
  if(collide(arena,player)) player.pos.x -= dir;
}

function playerReset(){
  const piece = pieces[Math.floor(Math.random()*pieces.length)];
  player.matrix = createPiece(piece);
  player.pos.y=0;
  player.pos.x=(arena[0].length/2 |0)-(player.matrix[0].length/2|0);
  if(collide(arena,player)){
    gameOver();
  }
}

function playerRotate(){
  const m=player.matrix;
  for(let y=0;y<m.length;y++){ for(let x=0;x<y;x++){ [m[x][y],m[y][x]]=[m[y][x],m[x][y]]; } }
  m.forEach(row=>row.reverse());
  if(collide(arena,player)){
    for(let i=0;i<3;i++) playerRotate();
  }
}

function drawMatrix(matrix,offset){
  matrix.forEach((row,y)=>{ row.forEach((value,x)=>{ if(value!==0){ context.fillStyle=`hsl(${value*40},100%,50%)`; context.fillRect(x+offset.x,y+offset.y,1,1);}});});
}

function draw(){
  context.fillStyle="#000";
  context.fillRect(0,0,canvas.width,canvas.height);
  drawMatrix(arena,{x:0,y:0});
  drawMatrix(player.matrix,player.pos);
}

function update(time=0){
  const delta = time-lastTime;
  lastTime = time;
  dropCounter += delta;
  if(dropCounter>dropInterval) playerDrop();
  draw();
  requestAnimationFrame(update);
}

function updateScore(){
  document.title=`Tetris | Score: ${player.score}`;
}

// ----- Firebase Leaderboard -----
async function saveScore(name, score){
  if(!name) return;
  await addDoc(collection(db,"scores"),{player:name,score,createdAt:new Date()});
  loadLeaderboard();
}

async function loadLeaderboard(){
  const q = query(collection(db,"scores"), orderBy("score","desc"), limit(5));
  const snapshot = await getDocs(q);
  const list = document.getElementById("leaderboard-list");
  list.innerHTML="";
  snapshot.forEach(doc=>{
    const d=doc.data();
    const li=document.createElement("li");
    li.textContent=`${d.player}: ${d.score}`;
    list.appendChild(li);
  });
}

// ----- Game Over -----
function gameOver(){
  const name = prompt("Game Over! Enter your name:","Player");
  saveScore(name,player.score);
  arena.forEach(row=>row.fill(0));
  player.score=0;
  updateScore();
}

// ----- Controls -----
function move(dir){ playerMove(dir); }
function rotate(){ playerRotate(); }
function drop(){ playerDrop(); }

document.addEventListener("keydown", e=>{
  if(e.key==="ArrowLeft") playerMove(-1);
  else if(e.key==="ArrowRight") playerMove(1);
  else if(e.key==="ArrowDown") playerDrop();
  else if(e.key==="ArrowUp") playerRotate();
});

// ----- Start Game -----
playerReset();
update();
loadLeaderboard();
</script>
</body>
</html>
